  version: 2
  jobs:
    build:
      docker:
        - image: buildpack-deps:xenial
      steps:
        - checkout

        - run:
          name: Installing apt-get dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y autoconf automake libtool cmake

        - run:
          name: Installing zstd
          command: |
            wget https://github.com/facebook/zstd/archive/v1.3.4.tar.gz -O - | tar -xz
            cd zstd-1.3.4
            make && make install

        - run:
          name: Installing squashfuse
          command: |
            wget https://github.com/vasi/squashfuse/archive/0.1.103.tar.gz -O - | tar -xz
            cd squashfuse-0.1.103
            ./autogen.sh && ./configure && make && make install

        - run:
          name: Installing squashfs-tools
          command: |
            wget https://github.com/plougher/squashfs-tools/archive/fb33dfc32b131a1162dcf0e35bd88254ae10e265.tar.gz -O - | tar -xz
            cd squashfs-tools-fb33dfc32b131a1162dcf0e35bd88254ae10e265/squashfs-tools
            make ZSTD_SUPPORT=1 && make install

        # - run:
        #   name: Installing CMake
        #   command: |
        #     wget -O cmake.sh https://cmake.org/files/v3.11/cmake-3.11.0-Linux-x86_64.sh
        #     sh cmake.sh --prefix=/usr/local --skip-license

        - run:
          name: Installing GTest
          command: |
            wget https://github.com/google/googletest/archive/release-1.8.0.tar.gz -O - | tar -xz
            cd googletest-release-1.8.0
            mkdir build && cd build && cmake -G "Unix Makefiles" .. && make && make install
        # cp -r googletest-release-1.8.0/googletest/include/gtest /usr/local/include
        # cp googletest-release-1.8.0/build/googlemock/gtest/lib*.a /usr/local/lib

        - run:
          name: Build
          command: |
            cmake . && make
            python setup.py bdist_xar

        - run:
          name: Test
          command: |
            make test
            tox
        - run: cmake . && make && make test
        # Test the Python code
        - run: pip install tox && tox
        # Build the make_xar as a XAR
        - run: python setup.py bdist_xar
        # Run the XAR which requires squashfuse_ll
        - run: ./xarexec_fuse dist/make_xar.xar --help
    test:
